name: VPS with SSHx + Telegram Bot

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  vps:
    runs-on: ubuntu-latest

    steps:
    - name: Setup & install tools
      run: |
        sudo apt update && sudo apt install -y git nano htop python3 pip neofetch curl
        mkdir -p $HOME/data-to-backup
        mkdir -p $HOME/bot

    - name: Start SSHx
      run: |
        curl -sSf https://sshx.io/get | sh -s run > $HOME/bot/session.txt &
        sleep 10
        cat $HOME/bot/session.txt

    - name: Extract SSHx info & send to Telegram
      env:
        TELEGRAM_TOKEN: ${{ secrets.BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.CHAT_ID }}
      run: |
        LINK=$(grep -o 'https://sshx.io/[a-zA-Z0-9]*' $HOME/bot/session.txt | head -n1)
        SSH_CMD=$(grep -o 'ssh [^ ]*@[a-zA-Z0-9.]*' $HOME/bot/session.txt | head -n1)
        MSG=$(echo -e "âœ… *VPS is Ready!*\nðŸ”— [Web Access]($LINK)\nðŸ’» \`$SSH_CMD\`\nðŸ—‚ Folder: \$HOME/data-to-backup\nðŸ”§ Tools: git, nano, htop, python3, pip, neofetch")
        curl -s -X POST https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage \
          -d chat_id=$TELEGRAM_CHAT_ID \
          -d text="$MSG" \
          -d parse_mode="Markdown"

    - name: Run Telegram bot and wait
      env:
        TELEGRAM_TOKEN: ${{ secrets.BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.CHAT_ID }}
      run: |
        nohup python3 $HOME/bot/bot.py > $HOME/bot/log.txt 2>&1 &
        sleep 21000  # ~5.8 hrs

    - name: Auto-backup before shutdown
      if: always()
      env:
        TELEGRAM_TOKEN: ${{ secrets.BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.CHAT_ID }}
      run: |
        tar -czf /tmp/data.tar.gz -C $HOME/data-to-backup . || echo "No backup"
        curl -F document=@/tmp/data.tar.gz \
          "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendDocument?chat_id=$TELEGRAM_CHAT_ID&caption=ðŸ“¦ Auto Backup"

    - name: Notify Telegram (Shutdown)
      if: always()
      env:
        TELEGRAM_TOKEN: ${{ secrets.BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.CHAT_ID }}
      run: |
        curl -s -X POST https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage \
          -d chat_id="$TELEGRAM_CHAT_ID" \
          -d text="ðŸš« VPS session ended. Auto-shutdown completed."
