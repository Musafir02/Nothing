name: VPS over Serveo with Telegram Backup

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *" # Every 6 hours

env:
  BOT_TOKEN: 8089763429:AAEhSweDHApGjkANN6XQiyVSZnHKNT9AK9U
  CHAT_ID: 5497853349

jobs:
  vps:
    runs-on: ubuntu-latest
    steps:
    - name: Pre-run setup and install tools
      run: |
        sudo apt update && sudo apt upgrade -y
        sudo apt install -y openssh-server curl wget git htop nano unzip python3 python3-pip net-tools neofetch

    - name: Setup SSH and create user
      run: |
        sudo useradd -m -s /bin/bash github
        echo "github:githubvps" | sudo chpasswd
        echo "root:githubvps" | sudo chpasswd

        sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
        sudo systemctl restart ssh

    - name: Restore backup from Telegram
      run: |
        sudo -u github mkdir -p /home/github/data-to-backup
        FILE_ID=$(curl -s "https://api.telegram.org/bot${BOT_TOKEN}/getUpdates" | grep -oP '(?<="file_id":")[^"]+' | head -n 1)
        if [ "$FILE_ID" != "" ]; then
          FILE_PATH=$(curl -s "https://api.telegram.org/bot${BOT_TOKEN}/getFile?file_id=$FILE_ID" | grep -oP '(?<="file_path":")[^"]+')
          wget -q "https://api.telegram.org/file/bot${BOT_TOKEN}/${FILE_PATH}" -O /tmp/data.tar.gz
          sudo -u github tar -xzf /tmp/data.tar.gz -C /home/github/data-to-backup
        fi

    - name: Start SSH tunnel with Serveo
      run: |
        echo "Hold on... setting up tunnel..."
        ssh -o StrictHostKeyChecking=no -R 22222:localhost:22 serveo.net & sleep 10

    - name: Show connection info
      run: |
        echo "==============================="
        echo "✅ VPS is ready!"
        echo "🔗 SSH Command:"
        echo "ssh github@serveo.net -p 22222"
        echo "🔐 Password: githubvps"
        echo "🗂 Folder: /home/github/data-to-backup"
        echo "🧠 Tools: git, nano, htop, python3, pip, neofetch"
        echo "==============================="

    - name: Backup before shutdown
      if: always()
      run: |
        sudo -u github tar -czf /tmp/data.tar.gz -C /home/github/data-to-backup .
        curl -F chat_id=${CHAT_ID} -F document=@/tmp/data.tar.gz https://api.telegram.org/bot${BOT_TOKEN}/sendDocument
