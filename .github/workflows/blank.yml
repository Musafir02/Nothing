name: Persistent Ngrok VPS with Telegram Backup

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

env:
  BOT_TOKEN: 8089763429:AAEhSweDHApGjkANN6XQiyVSZnHKNT9AK9U
  CHAT_ID: 5497853349

jobs:
  vps:
    runs-on: ubuntu-latest
    steps:

    - name: Set up SSH access
      run: |
        sudo apt update
        sudo apt install -y openssh-server curl wget unzip

        sudo useradd -m -s /bin/bash github
        echo "github:githubvps" | sudo chpasswd
        echo "root:githubvps" | sudo chpasswd

        sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
        sudo systemctl restart ssh

    - name: Install Ngrok and start tunnel
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-linux-amd64.zip -O ngrok.zip
        unzip ngrok.zip
        sudo mv ngrok /usr/local/bin
        ngrok config add-authtoken 2yubfg6xRchiFwfklwjiv1DWL5m_3neNX8gDyQH9x2z7cK7b4
        ngrok tcp 22 & sleep 8

    - name: Get Ngrok public address
      id: tunnel
      run: |
        tunnel_url=$(curl -s http://127.0.0.1:4040/api/tunnels | grep -o 'tcp://[0-9a-zA-Z\.:\-]*')
        echo "HOST=$(echo $tunnel_url | cut -d/ -f3 | cut -d: -f1)" >> $GITHUB_ENV
        echo "PORT=$(echo $tunnel_url | cut -d: -f3)" >> $GITHUB_ENV
        echo "NGROK_TUNNEL=$tunnel_url" >> $GITHUB_ENV

    - name: Restore backup from Telegram
      run: |
        mkdir -p /home/github/data-to-backup
        FILE_ID=$(curl -s "https://api.telegram.org/bot${BOT_TOKEN}/getUpdates" | grep -oP '(?<="file_id":")[^"]+' | head -n 1)
        if [ "$FILE_ID" != "" ]; then
          FILE_PATH=$(curl -s "https://api.telegram.org/bot${BOT_TOKEN}/getFile?file_id=$FILE_ID" | grep -oP '(?<="file_path":")[^"]+')
          wget -q "https://api.telegram.org/file/bot${BOT_TOKEN}/${FILE_PATH}" -O /tmp/data.tar.gz
          tar -xzf /tmp/data.tar.gz -C /home/github/data-to-backup
        fi

    - name: Print SSH command
      run: |
        echo "======================================"
        echo "âœ… VPS is ready!"
        echo "ðŸ‘‰ SSH command:"
        echo "ssh github@$HOST -p $PORT"
        echo "ðŸ” Password: githubvps"
        echo "ðŸ—‚  Persistent folder: /home/github/data-to-backup"
        echo "======================================"

    - name: Backup to Telegram before shutdown
      if: always()
      run: |
        tar -czf /tmp/data.tar.gz -C /home/github/data-to-backup .
        curl -F chat_id=${CHAT_ID} -F document=@/tmp/data.tar.gz https://api.telegram.org/bot${BOT_TOKEN}/sendDocument
