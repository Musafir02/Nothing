name: VPS with SSHx, Telegram, and Backup

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *' # Runs every 6 hours

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Set up job
        run: echo "Setting up VPS job..."

      - name: Install SSHx and start session
        run: |
          curl -sSf https://sshx.io/get | sh -s run > session.log &
          sleep 15
          cat session.log | tee /tmp/sshx_link.txt

      - name: Install tools and prep directory
        run: |
          sudo apt update && sudo apt install -y git nano htop python3 pip neofetch
          mkdir -p /home/github/data-to-backup

      - name: Restore backup from Telegram
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "Restoring from Telegram"
          curl -s -o /tmp/data.tar.gz "https://api.telegram.org/bot$TELEGRAM_TOKEN/getFile?file_id=YOUR_FILE_ID"
          tar -xzf /tmp/data.tar.gz -C /home/github/data-to-backup || echo "No backup found"

      - name: Notify Telegram (VPS Ready)
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          LINK=$(cat /tmp/sshx_link.txt | grep 'Web shell')
          MSG="\nâœ… *VPS is Ready!*\nðŸ”— $LINK\nðŸ—‚ Folder: /home/github/data-to-backup\nðŸ”§ Tools: git, nano, htop, python3, pip, neofetch"
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$MSG" \
            -d parse_mode="Markdown"

      - name: Wait for manual work or bot command
        run: sleep 21000 # ~5.8 hours

      - name: Backup to Telegram before shutdown
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          tar -czf /tmp/data.tar.gz -C /home/github/data-to-backup .
          curl -F document=@/tmp/data.tar.gz "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendDocument" \
            -F chat_id="$TELEGRAM_CHAT_ID" -F caption="ðŸ“¦ VPS Backup (Auto Upload)"

      - name: Notify Telegram (VPS Shutdown)
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="ðŸš« VPS session ended. Auto-shutdown completed."
